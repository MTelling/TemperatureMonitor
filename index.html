<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Temperature Monitor</title>
        <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
        <![endif]-->

        <!-- Init plotting script -->
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    </head>
    <body>
        
        <h2>Temperature Monitor</h2>

        <div id="temperature-container">
            <p>Temperature: <span id="temperature"></span> at <span id="time"></span></p>
            <h3 id="updated"></h3>
        </div>

        <div id="myDiv" style="width: 800px; height: 400px;">


        

        <!-- Init socket.io -->
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io();
            var temp = document.getElementById('temperature');
            var requestNew = function() {
                console.log("Requesting new temp.");
                socket.emit("refreshTemp");
            };

            // Request new data immediately at first connection.
            requestNew();

            const interval = 1000 * 3 // 1000ms * x

            setInterval(function() { requestNew() }, interval);


            var last = {};
            socket.on('newTemp', (data) => {
                console.log("Received data.");
                temperature.innerText = data.temperature;
                time.innerText = new Date(data.date);
                console.log("Last:" + last.date);
                console.log("Current:" + data.date);
                if (last.date != data.date) {
                    updated.innerText = "Updated!";
                    last = data;
                } else {
                    updated.innerText = "";
                }
            });
        </script>




        <!-- Init graph -->
        <script>
            socket.emit('requestLongTerm', 1000);
            

            socket.on('sentLongTerm', (data) => {

                var temps = [];
                var datetimes = [];
                data.forEach((datapoint) => {
                    temps.push(datapoint.temperature);
                    let date = new Date(datapoint.date); 
                    var str_date = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                    datetimes.push(str_date);
                });

                temps.reverse();
                datetimes.reverse();

                console.log(temps);
                console.log(datetimes);
                
                var data = [
                  {
                    y: temps,
                    x: datetimes,
                    type: 'line',
                    line: {
                        width: 1,
                        shape: 'spline'
                    }
                  }
                ];

                TESTER = document.getElementById('tester');
                
                Plotly.plot('myDiv', data);
            });
            

        </script>







    </body>
</html>